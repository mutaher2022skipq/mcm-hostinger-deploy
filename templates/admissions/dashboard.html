{% extends 'base.html' %}
{% block content %}

<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-8">

  <!-- HEADER -->
  <div class="flex justify-between items-center border-b border-gray-200 pb-4 mb-6">
    <div>
      <h2 class="text-2xl font-bold text-mcmGreen">üéì Student Dashboard</h2>
      <p class="text-gray-500 text-sm mt-1">
        Welcome, <strong>{{ request.user.username }}</strong>
      </p>
    </div>

    <div class="text-right">
      <p class="text-sm text-gray-600">
        <strong>Class Applied:</strong> {{ request.user.class_applied|default:"Not selected" }}
      </p>
      <p class="text-sm text-gray-600">
        <strong>DOB:</strong> {{ request.user.dob|date:"M d, Y"|default:"‚Äî" }}
      </p>
    </div>
  </div>

  <!-- PROGRESS + STATUS -->
  <div class="flex flex-col md:flex-row items-center justify-between gap-6">

    <!-- Circular Progress Chart -->
    <div class="flex flex-col items-center">
      <div class="relative w-36 h-36">
        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
          <path class="text-gray-300" stroke-width="3" fill="none"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
          <path class="text-mcmGold stroke-current" stroke-width="3" fill="none" stroke-dasharray="{{ progress }}, 100"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
        </svg>
        <span class="absolute inset-0 flex items-center justify-center text-mcmGreen font-semibold text-sm">
          {{ label }}
        </span>
      </div>

      <p class="text-xs text-gray-500 mt-2">
        Application Status:
        {% if application.status == 'verified' %}
        <span class="text-green-600 font-semibold">Verified</span>
        {% elif application.status == 'submitted' %}
        <span class="text-blue-600 font-semibold">Submitted</span>
        {% elif application.status == 'payment_pending' %}
        <span class="text-yellow-600 font-semibold">Payment Pending</span>
        {% elif application.status == 'draft' %}
        <span class="text-gray-600 font-semibold">Draft</span>
        {% else %}
        <span class="text-gray-400 font-semibold">Not Started</span>
        {% endif %}
      </p>
    </div>

    <!-- Summary Card -->
    <div class="bg-gray-50 rounded-xl p-6 shadow-inner w-full md:w-2/3">
      <h3 class="text-lg font-bold text-mcmGreen mb-3">üìã Application Summary</h3>

      <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">

        <p><strong>Status:</strong> {{ application.status|title }}</p>
        <p><strong>Submission Date:</strong> {{ application.submission_date|default:"Not Submitted" }}</p>

        <!-- DYNAMIC FEE SECTION -->
        <p>
          <strong>Fee Amount:</strong>
          {% if admissions_closed %}
          <span class="text-red-600 font-semibold">Admissions Closed</span>
          {% elif amount %}
          Rs {{ amount }}
          {% else %}
          <span class="text-gray-500 italic">Not assigned yet</span>
          {% endif %}
        </p>

        <p>
          <strong>Fee Tier:</strong>
          {% if fee_tier == "normal" %}
          <span class="text-green-600 font-semibold">Normal</span>
          {% elif fee_tier == "late" %}
          <span class="text-yellow-600 font-semibold">Late Fee</span>
          {% elif fee_tier == "double" %}
          <span class="text-blue-600 font-semibold">Double Fee</span>
          {% elif fee_tier == "triple" %}
          <span class="text-purple-600 font-semibold">Triple Fee</span>
          {% elif fee_tier == "final" %}
          <span class="text-red-600 font-semibold">Final Late Fee</span>
          {% else %}
          <span class="text-gray-500 italic">‚Äî</span>
          {% endif %}
        </p>

        <p><strong>Category:</strong> {{ application.get_category_display|default:"Not Selected" }}</p>
        <p><strong>Entry:</strong> {{ application.entry|default:"Entry Not Assigned" }}</p>
        <p><strong>Challan #:</strong> {{ application.challan_no|default:"‚Äî" }}</p>

      </div>
    </div>
  </div>

  <!-- ROLL NUMBER SECTION -->
  {% if application.roll_number %}
  <div class="mt-8 bg-green-50 border border-green-200 rounded-xl p-5 text-center shadow-md">
    <h3 class="text-lg font-bold text-green-700 mb-1">üéüÔ∏è Roll Number Assigned</h3>
    <p class="text-2xl font-extrabold text-green-800 tracking-widest">{{ application.roll_number }}</p>
    <p class="text-sm text-green-600 mt-1">Please note this for your written test.</p>

    {% if application.status == 'verified' and application.roll_slip %}
    <div class="mt-4">
      <a href="{% url 'admissions:download_roll_slip_dashboard' %}"
        class="inline-block bg-mcmGreen text-white font-semibold px-6 py-2 rounded-lg shadow hover:bg-mcmOlive transition transform hover:scale-105">
        üé´ Download Roll Number Slip
      </a>
      <p class="text-gray-500 text-xs mt-2">
        Bring this printed slip to your test center.
      </p>
    </div>
    {% endif %}
  </div>

  {% elif application.status == 'verified' %}
  <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-center shadow-md">
    <p class="text-yellow-700 font-semibold">Roll number will be issued shortly.</p>
  </div>
  {% endif %}

  <!-- ACTION BUTTONS -->
  <div class="mt-10 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

    <a href="{% url 'admissions:complete_form' %}"
      class="flex items-center justify-center bg-mcmGreen text-white py-3 rounded-xl font-semibold hover:bg-mcmOlive transition shadow-md">
      ‚úçÔ∏è Complete Application Form
    </a>

    <a href="{% url 'admissions:view_application' %}"
      class="flex items-center justify-center bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition shadow-md">
      üìÑ View Submitted Details
    </a>

    <a href="{% url 'admissions:print_challan' %}" target="_blank"
      onclick="document.getElementById('upload-challan-btn').classList.remove('hidden')"
      class="flex items-center justify-center bg-mcmGold text-gray-900 py-3 rounded-xl font-semibold hover:bg-yellow-400 transition shadow-md">
      üßæ Print Challan Form
    </a>

  </div>

  <!-- Upload Challan Button (Large & Centered) -->
  <div class="mt-8 flex justify-center">
    <a href="{% url 'admissions:upload_fee_slip' %}" id="upload-challan-btn"
      class="{% if not application.challan_no %}hidden{% endif %} w-full md:w-2/3 lg:w-1/2 flex items-center justify-center bg-indigo-600 text-white text-lg py-4 rounded-2xl font-bold hover:bg-indigo-700 transition shadow-lg transform hover:scale-105">
      üí∞ Upload Challan Form
    </a>
  </div>

  <!-- Notifications -->
  {% if notifications %}
  <div class="mt-10 bg-gray-50 border border-gray-200 rounded-xl shadow-md p-6">
    <h3 class="text-lg font-bold text-mcmGreen mb-3">üì¨ Recent Notifications</h3>

    <ul class="space-y-2 text-sm">
      {% for note in notifications %}
      <li
        class="flex items-start justify-between bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:bg-gray-50 transition">
        <div>
          <p class="font-semibold text-gray-800">{{ note.title }}</p>
          <p class="text-gray-600">{{ note.message }}</p>
          <p class="text-xs text-gray-400 mt-1">{{ note.created_at|date:"M d, Y h:i A" }}</p>
        </div>

        {% if not note.is_read %}
        <span class="text-xs bg-red-100 text-red-600 font-semibold px-2 py-0.5 rounded">New</span>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

</div>

<!-- Instructions Modal (Elegant Design) -->
<div id="instruction-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title"
  role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 text-center sm:block sm:p-0">

    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-60 transition-opacity backdrop-blur-sm" aria-hidden="true"></div>

    <!-- Centering Spacer -->
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <!-- Modal Panel -->
    <div
      class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full border border-gray-100">

      <!-- Header with Gradient -->
      <div class="bg-gradient-to-r from-mcmGreen to-mcmOlive px-6 py-5">
        <div class="flex items-center gap-3">
          <div class="bg-white/20 p-2 rounded-full backdrop-blur-md">
            <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white tracking-wide" id="modal-title">
            Welcome to Admission Portal
          </h3>
        </div>
      </div>

      <!-- Content -->
      <div class="px-6 py-6 bg-white">
        <p class="text-gray-500 text-sm mb-5">Please follow these steps to complete your admission process:</p>

        <div class="space-y-4">
          <!-- Step 1 -->
          <div class="flex items-start gap-4 p-3 rounded-xl bg-blue-50 border border-blue-100">
            <div class="flex-shrink-0 mt-0.5">
              <span
                class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-bold">1</span>
            </div>
            <p class="text-sm text-gray-700">
              Click on <span class="font-bold text-blue-700">"Complete Application Form"</span> and fill out your
              details carefully.
            </p>
          </div>

          <!-- Step 2 -->
          <div class="flex items-start gap-4 p-3 rounded-xl bg-yellow-50 border border-yellow-100">
            <div class="flex-shrink-0 mt-0.5">
              <span
                class="flex items-center justify-center w-6 h-6 rounded-full bg-yellow-600 text-white text-xs font-bold">2</span>
            </div>
            <p class="text-sm text-gray-700">
              After submission, <span class="font-bold text-yellow-700">Print the Challan</span> and deposit the fee at
              the designated bank.
            </p>
          </div>

          <!-- Step 3 -->
          <div class="flex items-start gap-4 p-3 rounded-xl bg-green-50 border border-green-100">
            <div class="flex-shrink-0 mt-0.5">
              <span
                class="flex items-center justify-center w-6 h-6 rounded-full bg-green-600 text-white text-xs font-bold">3</span>
            </div>
            <p class="text-sm text-gray-700">
              Once paid, click <span class="font-bold text-green-700">"Upload Challan Form"</span> to upload your slip
              for roll number assignment.
            </p>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse border-t border-gray-100">
        <button type="button" onclick="closeInstructionModal()"
          class="w-full inline-flex justify-center items-center rounded-xl border border-transparent shadow-lg px-6 py-3 bg-mcmGreen text-base font-bold text-white hover:bg-mcmOlive focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-mcmGreen transition transform hover:-translate-y-0.5 sm:w-auto sm:text-sm">
          Got it, let's start! üöÄ
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('instruction-modal');

    // Show modal on load
    modal.classList.remove('hidden');

    // Auto-close after 10 minutes (600,000 ms)
    setTimeout(function () {
      closeInstructionModal();
    }, 600000);
  });

  function closeInstructionModal() {
    const modal = document.getElementById('instruction-modal');
    modal.classList.add('hidden');
  }
</script>

{% endblock %}